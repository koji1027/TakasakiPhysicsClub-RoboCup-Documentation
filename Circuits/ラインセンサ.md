ロボカップでアウトオブバウンズを防ぐために必須なラインセンサの原理、作り方をまとめました。

## 物体の色が見える仕組み
私たちの目に映る物体の色は、光の反射によって生まれます。この原理を理解することは、ラインセンサの仕組みを理解する基礎となります。

### 光の反射と色の関係
白色光（太陽光や蛍光灯など）には、赤(R)、緑(G)、青(B)の3原色が含まれています。物体に白色光が当たると、物体の性質によって特定の色の光だけが反射され、その他の色は吸収されます。
以下のような反射の特徴があります。
- 赤い物体は、赤い光だけを反射し、他の色を吸収します
- 黄色い物体は、赤と緑の光を反射します
- 白い物体は、すべての色（赤、緑、青）を反射します
- 黒い物体は、ほとんどすべての光を吸収します

### センサへの応用
この色の原理は、カラーセンサの設計に直接応用されています。カラーセンサは人間の目と同じように、物体から反射された光のRGB成分を検出します。
具体的には、
1. センサが白色光を物体に照射します
2. 物体から反射された光をRGB各色に分けて検出します
3. 各色の反射量の比率から物体の色を判定します3

このような原理を応用することで、ラインセンサは移動する物体の色情報を正確に読み取ることができます。

### ロボカップで使うLEDの色
ロボカップサッカーではコートの緑色と白線が区別できれば十分です。上述のような様々な色を見分けられる必要は無く、このセンサを実装するのは過剰です。（サッカーコートのゴールの色は距離が遠すぎるのでこの方式のカラーセンサでは認識できません。カメラを利用してください。）

我々が作るラインセンサは緑色と白色が区別できれば十分だとわかりました。では、そのためにもっとも効果的な方法を考えましょう。例えば、緑色が0(LOW)で、白色が1(HIGH)になったら嬉しいのではないでしょうか？以下ではそうなるようにセンサを考えてみます。

白色はすべての色を反射します。基本的にどんな色を照射しても強く反射されるのでセンサは1(HIGH)を得ます。一方、緑色は緑色を一番強く反射し、赤色と青色を吸収してしまいます。色相環を見れば緑色の捕食が赤色になっていることがわかります。つまり、例えば赤色を照射してあげれば0(LOW)となると考えられます。
![img](https://zokeifile.musabi.ac.jp/wpwp/wp-content/uploads/2014/08/059_hue-circle_01.jpg)

| 物体の色    | R（赤色）                        | G（緑色）                       | B（青色）                        |
| ------- | ---------------------------- | --------------------------- | ---------------------------- |
| 白色（ライン） | <font color="red">○</front>  | <font color="red">○</front> | <font color="red">○</front>  |
| 緑色（コート） | <font color="blue">✕</front> | <font color="red">○</front> | <font color="blue">✕</front> |
※「<font color="red">○</front>」は反射する。「<font color="blue">✕</front>」は吸収する。

実際にロボカップのラインセンサでは赤色光をコートに照射しその反射光の強さを測定することでコート上にいるのかライン上にいるのか判別します。青色も良さそうに思えますがおすすめできません。**ロボカップサッカーでは一方のコートの色として青色が採用されており、ロボットに青色の部分があることが許されていないためです。** また、コートに照射して反射された光が減衰したり、ロボットの外に漏れてしまわないようにLEDとセンサは地面すれすれにつけます。（あまりに地面すれすれにするのは良くないのは言うまでもありません。）

## フォトトランジスタについて
先ほどから光の強度を測定するとずっと言っていますが、センサについて何も解説していなかったのでここで解説します。ラインセンサには**フォトトランジスタ**を利用します。

### 基本構造と動作原理
フォトトランジスタは、光を電気信号に変換する半導体素子で、フォトダイオードとトランジスタを組み合わせた構造を持っています。

### 光電流の発生と増幅
- フォトトランジスタに光が当たると、内部のフォトダイオード部分で光電流が発生します。
- 発生した光電流はNPNトランジスタのベースに流れ込み、hFE倍（数百倍）に増幅されて出力されます。

### 特性と性能
- 電流特性
	- 暗状態（光が当たっていない時）: 暗電流 約10^-9A
	- 光照射時: 光電流 数mA2
	- この電流レベルの大きな差（約10^6倍）を利用して、物体の検出が可能となります2。

### 回路での使用方法
一般的な使用例として
 - 光が当たっていない時は電流が流れず、後段のトランジスタは0(LOW)
- 光が当たると電流が流れ、後段のトランジスタがオンになる1(HIGH)

## ラインセンサの概観
- LEDを利用して地面に赤色LEDを照射する
	- 普通のLEDでも多分大丈夫だが高輝度LEDというものをつかうと良いかも
		- 光があまりにも強いとLEDからの光が直接フォトトランジスタに入ってしまって線sなとして機能しない。場合によっては直接光が入らないようにカバーを付ける必要がある。
		- 高輝度なLEDほど指向性が強い。（光がまっすぐに出てくる。広がらない）LEDとフォトトランジスタの角度をあわせないと反射光がうまく入射してくれない。
	- 私は、Neopixelを利用した
		- マイコン内蔵LEDと呼ばれており、色と輝度をプログラムで調整できる。
		- 信号線が1本で済む。数珠つなぎできる。
		- いっぱい搭載して最高輝度で光らせていたらかなり消費電力が大きかった。
		- フルカラーなので遊べて楽しい。
		- はんだ付けが難しい。

## 回路

## プログラム
回路図上でLINEと名付けたピンをアナログ入力で読んであげましょう。適当に結果をシリアルモニタに出力しましょう。白線上にいる時と緑のコート上にいる時の値を比較すれば、前者では電圧値が非常に大きく、後者では電圧値が非常に低くなると思います。あとはいい感じにif文で条件分岐してやればおしまいです。実はラインセンサは非常にシンプルで簡単なものなのでさっさと終えてしまいましょう。
